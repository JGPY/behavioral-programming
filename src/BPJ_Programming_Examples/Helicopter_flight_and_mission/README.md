
## Reference source
http://wiki.weizmann.ac.il/bp/index.php/Helicopter_flight_and_mission


## Contents

    1 Helicopter Flight Examples
    2 Basic Composite Behavior
    3 Detailed Example: Wall Painting
        3.1 Requirements
        3.2 Events
        3.3 General control events
            3.3.1 Move Events
        3.4 BPJ b-threads
            3.4.1 General control b-threads
            3.4.2 Actuator b-threads
            3.4.3 Color control b-threads
            3.4.4 Location correction b-threads
            3.4.5 Environment Simulation
    4 Incremental Development Notes
    5 LSC Integration
    6 Design Notes
    7 Download
        7.1 Download the wall painting example

## Helicopter Flight Examples

The examples below demonstrates the control of a toy helicopter - AR DRONE by Parrot Inc.

## Basic Composite Behavior

The following movies show flight of the helicopter, as well as simulation. The flight was generated by independent concurrent LSCs - where one directs the helicopter through a rectangular flight path without changing altitude, and another directs the helicopter to go up and down without changing its horizontal location. The result is a composite motion, traveling the prescribed path while going up and down.


## Detailed Example: Wall Painting

In this example, the mission here is to paint a wall with different colors. This can be considered as an analogy to a photography mission where a particular area as to be covered.

The example is implemented with a simulator.

Below we describe the requirements and the associated b-threads, along with screen images and a movie of the helicopter behavior as it evolves with the addition of new b-threads.


### Requirements

The requirements below were added incrementally, and b-threads were added to deal with each requirement. In the simulator - the painting of the wall is by drawing a line on the screen.


    The helicopter should go up and down along the wall.
    When the helicopter reaches the ceiling or the floor it should move to the right
    Every fixed number of pixels the paint color should be changed
    Since the line drawn by the helicopter is thin, after every small vertical move, the helicopter should move right and left with horizontal brush strokes, before moving vertically again.
    The helicopter may move from its present location due to wind.
    If the helicopter is moved by wind, it should return to its last known location.

In the integration with LSC, two more requirements were added

    The amount of paint is limited. After a certain number of points is painted - the paint runs out.
    When paint of a certain color runs out, this color can no longer be used.
    When all paint colors run out, the helicopter must stop.
    Paint cans may be re-filled. This is simulated by a user clicking on a button on the screen.

### Events
### General control events

    BeginPainting: Start the painting process
    StopPainting: End the painting process
    MoveDown: Move down a fixed number of pixels.
    EndOfColUp: End painting wall going up
    DoColDownL Start painting wall going down
    EndOfColDown: End painting wall going up
    DoRowRight: Start painting wall going right
    EndOfRowRight: Stop moving right.
    ChangeColor: This is an event class of which there are four events, indicating a request to change the painting color to the corresponding one in the event name:
        eChangeColorBLACK
        eChangeColorRED
        eChangeColorBLUE
        eChangeColorGreen
    UpdateArrived: simulate information from a GPS with actual helicopter location

#### Move Events

The following events indicate the desire to move a fixed number of pixels in the desired direction. These events have a data field - indicating whether the movement is for a mission or for maintenance, which serves in correcting wind shifts.

    MoveUp: Move down a fixed number of pixels
    MoveDown: Move down a fixed number of pixels
    MoveLeft: Move left a fixed number of pixels
    MoveRight: Move right a fixed number of pixels

### BPJ b-threads
#### General control b-threads

    DoColD2U: Controls coloring in the up direction;
    YAxis: Reports when helicopter reaches top or bottom end of wall (ceiling of floor)
    EndColUp: Handle reaching of ceiling. Stop moving vertically, start moving right.
    DoRowL2R: Left to right painting - waits for DoRowRight and then repeatedly requests movement to the right until end of right movement is reached.
    XAxis: Monitor horizontal coordinates. Report reaching of right and left borders of wall, and report end of movement right to start a new column
    DoColU2D: Controls coloring in the up direction
    EndColDown: Handles reaching the floor - requests a movement to the right
    BrushMove: Move the brush right and left (horizontal moves) to create a thicker line and paint continuous area. This b-thread performs its actions between any two vertical moves.


#### Actuator b-threads

The following b-threads wait for the corresponding move event and call the helicopter API (or the simulator) to cause the actual movement.

    MovingRight
    MovingLeft
    MovingDown
    MovingUp

#### Color control b-threads

    ChangePaintingColor: Waits for the need to change color and changes the color randomly.

#### Location correction b-threads

    FixWind: When a report comes in that the helicopter is not where it is supposed to be - stop painting movement and return to last known location.

#### Environment Simulation

    ColorControl: Counts movements and announces the need to change color.
    Wind: Every certain random number of steps, report a random location of the helicopter

## Incremental Development Notes


With only basic movements and no color change b-threads:
Black - thin.jpg


Basic movements with color changes:
Color-thin.jpg

Adding horizontal brush movements:
Color-thick.jpg

Random movements due to wind, and return by horizontal movement and then vertical to last known location:
FixWind.jpg

## LSC Integration

The BPJ-based system was then integrated with the LSC language via PlayGo. For details how to integrate a BPJ application with LSC see a separate section in this documentation.

The following LSC (scenario) was added

* PaintCanEmpty: Waits for a certain number of movements with a given color and block subsequent changes to that color, simulating and empty can, until an event of PaintFilled arrives. This event is generated by the user clicking on a corresponding GUI Button.

## Design Notes

The following design patterns and choices can be seen throughout the example.

* Events can be distinguishes from each other by
    * Class - different classes of events
    * Name - multiple instances of an events of the same class distinguished by their name (e.g. the color change events).
    * Data field - Two instances of events of the same class, with arbitrary names can be distinguished by a value in one of the event data fields (e.g. the maintenance vs. mission indicator in the move events).

* One activity can interfere with another by using
    * priority - (relative priority among b-thread)
    * blocking the events of the other activity (which can be distinguished as described above)

* Distinguishing internal and external events - those generated by the system/application and those generated by the environment (and which may be reported by sensors).
    * External events should not be blocked (enforced by convention only).
    * When external events are produced by simulator, the concepts of Logical Execution Time should be enforced by convention, where all internal events reacting to the last external event should be processed before generating the next external event.

## Download
### Download the wall painting example

1. Click here to download the wall painting example.
2. Installation Instructions:
    1. Import the downloaded project to your workspace:
        1. From the 'File' menu choose 'Import'-->'General'-->'Existing Projects into Workspace'.
        2. Click the 'Next' button.
        3. Click the 'Select archive file' option and then click the 'Browse...' button to select the downloaded zip file.
        4. Click 'Finish'.
    2. The helicopter example projects are now part of your workspace.
        1. The example includes three projects:
            1. BDrone - The main project that includes the b-threads that implement the drawing/scanning tasks.
            2. HeliSim - A simple java-based simulator.
            3. il.ac.wis.cs.rovtool.blender - A blender-based simulator.
    3. Refer to the BDrone/HowToRun.txt file for execution instructions.
